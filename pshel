# Program 1 - Directory Check

# Import the YAML module for parsing the configuration file
Import-Module powershell-yaml

# Read the configuration file
$config = Get-Content -Path "config.yml" | ConvertFrom-Yaml

# Global variables
$globalThresholdMet = $false
$emailBody = ""

# Checks the number of files in a directory against specified thresholds
function Check-FileCount {
    param (
        [string]$path,
        [array]$countThresholds,
        [string]$fileFilter
    )

    $fileCount = (Get-ChildItem -Path $path -File -Filter $fileFilter).Count
    $breachedThresholds = @()

    foreach ($threshold in $countThresholds) {
        if ($fileCount -ge $threshold.count) {
            $breachedThresholds += $threshold
            if ($threshold.count -ge 3) {
                $script:globalThresholdMet = $true
                $script:emailBody += "Threshold of 3 or more met in $path`n"
            }
            if ($threshold.count -ge 2) {
                Write-Output "Major error: Threshold of 2 or more met in $path"
            }
        }
    }

    if ($breachedThresholds.Count -gt 0) {
        $highestSeverity = ($breachedThresholds | Sort-Object severity | Select-Object -First 1).severity
        $highestCount = ($breachedThresholds | Sort-Object count -Descending | Select-Object -First 1).count
        
        Write-Output "Directory: $path (Filter: $fileFilter)"
        Write-Output "  Total files: $fileCount"
        Write-Output "  Highest Count Severity: $highestSeverity (Threshold: $highestCount files)"
        
        $breachedThresholds | ForEach-Object {
            Write-Output "  Breached: $($_.count) files (Severity: $($_.severity))"
        }
        Write-Output ""
    }

    return $fileCount
}

# Checks the age of files in a directory against specified time thresholds
function Check-FileAge {
    param (
        [string]$path,
        [array]$timeThresholds,
        [string]$fileFilter
    )

    $files = Get-ChildItem -Path $path -File -Filter $fileFilter

    foreach ($file in $files) {
        $fileAge = (Get-Date) - $file.LastWriteTime
        $ageInMinutes = $fileAge.TotalMinutes

        $breachedThresholds = @()
        foreach ($threshold in $timeThresholds) {
            if ($ageInMinutes -ge $threshold.minutes) {
                $breachedThresholds += $threshold
            }
        }

        if ($breachedThresholds.Count -gt 0) {
            $highestSeverity = ($breachedThresholds | Sort-Object severity | Select-Object -First 1).severity
            $longestTime = ($breachedThresholds | Sort-Object minutes -Descending | Select-Object -First 1).minutes
            
            Write-Output "File: $($file.Name) in $path"
            Write-Output "  Age: $($ageInMinutes.ToString('F2')) minutes"
            Write-Output "  Highest Time Severity: $highestSeverity (Threshold: $longestTime minutes)"
            
            $breachedThresholds | ForEach-Object {
                Write-Output "  Breached: $($_.minutes) minutes (Severity: $($_.severity))"
            }
            Write-Output ""
        }
    }
}

# Checks for zero-size files in a directory
function Check-ZeroSizeFiles {
    param (
        [string]$path,
        [int]$zeroSizeSeverity,
        [string]$fileFilter
    )

    $zeroSizeFiles = Get-ChildItem -Path $path -File -Filter $fileFilter | Where-Object { $_.Length -eq 0 }

    if ($zeroSizeFiles.Count -gt 0) {
        Write-Output "Zero-size files found in $path (Filter: $fileFilter) (Severity: $zeroSizeSeverity):"
        $zeroSizeFiles | ForEach-Object {
            Write-Output "  $($_.Name)"
        }
        Write-Output ""
    }

    return $zeroSizeFiles.Count
}

# Performs comprehensive checks on a directory
function Check-Directory {
    param (
        [string]$path,
        [array]$timeThresholds,
        [array]$countThresholds,
        [bool]$checkZeroSize,
        [int]$zeroSizeSeverity,
        [string]$fileFilter
    )

    Write-Output "Checking directory: $path (Filter: $fileFilter)"

    $fileCount = Check-FileCount -path $path -countThresholds $countThresholds -fileFilter $fileFilter

    Check-FileAge -path $path -timeThresholds $timeThresholds -fileFilter $fileFilter

    if ($checkZeroSize) {
        $zeroSizeCount = Check-ZeroSizeFiles -path $path -zeroSizeSeverity $zeroSizeSeverity -fileFilter $fileFilter
        Write-Output "Zero-size files found: $zeroSizeCount"
    }

    Write-Output "Total files matching filter in $path: $fileCount"
    Write-Output "-----------------------------"
}

# Main execution loop
foreach ($dir in $config.directory_check) {
    Check-Directory -path $dir.path `
                    -timeThresholds $dir.time_thresholds `
                    -countThresholds $dir.count_thresholds `
                    -checkZeroSize $dir.check_zero_size `
                    -zeroSizeSeverity $dir.zero_size_severity `
                    -fileFilter $dir.file_filter
}

# Check if the global threshold was met
if ($globalThresholdMet) {
    Write-Output "Global threshold met. Email body:"
    Write-Output $emailBody
}
